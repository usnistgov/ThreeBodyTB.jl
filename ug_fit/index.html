<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Fit Coefficients · ThreeBodyTB.jl Documentation</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/favicon.ico" rel="icon" type="image/x-icon"/><link href="../assets/nist-combined.css" rel="stylesheet" type="text/css"/>      <link rel="stylesheet" href="../assets/nist-combined.css"> <script src="../assets/jquery-1.9.0.min.js" type="text/javascript" defer="defer"></script><script src="../assets/nist-header-footer.js" type="text/javascript" defer="defer"></script><script async type="text/javascript" id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=NIST&subagency=github&pua=UA-66610693-1&yt=true&exts=ppsx,pps,f90,sch,rtf,wrl,txz,m1v,xlsm,msi,xsd,f,tif,eps,mpg,xml,pl,xlt,c"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ThreeBodyTB.jl Documentation logo"/></a><div class="docs-package-name"><span class="docs-autofit">ThreeBodyTB.jl Documentation</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../ug_run/">Running Calculations</a></li><li class="is-active"><a class="tocitem" href>Fit Coefficients</a><ul class="internal"><li><a class="tocitem" href="#.-Preliminaries"><span>0. Preliminaries</span></a></li><li><a class="tocitem" href="#.-Do-DFT-calculations."><span>1. Do DFT calculations.</span></a></li><li><a class="tocitem" href="#.-Create-the-tight-binding-Hamiltonian-for-each-DFT-calculation"><span>2. Create the tight-binding Hamiltonian for each DFT calculation</span></a></li><li><a class="tocitem" href="#.-Do-actual-fitting"><span>3. Do actual fitting</span></a></li><li><a class="tocitem" href="#.-Run-calculations-with-new-database"><span>4. Run calculations with new <code>database</code></span></a></li></ul></li></ul></li><li><span class="tocitem">Core User Interface</span><ul><li><a class="tocitem" href="../structs/">Structs</a></li><li><a class="tocitem" href="../core/">Functions</a></li></ul></li><li><a class="tocitem" href="../compile/">Compile/Python</a></li><li><a class="tocitem" href="../every/">Additional Docstrings</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">User Guide</a></li><li class="is-active"><a href>Fit Coefficients</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Fit Coefficients</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/usnistgov/ThreeBodyTB.jl/blob/master/docs/src/ug_fit.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Fitting-tight-binding-coefficients-from-Quantum-Espresso."><a class="docs-heading-anchor" href="#Fitting-tight-binding-coefficients-from-Quantum-Espresso.">Fitting tight-binding coefficients from Quantum Espresso.</a><a id="Fitting-tight-binding-coefficients-from-Quantum-Espresso.-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-tight-binding-coefficients-from-Quantum-Espresso." title="Permalink"></a></h1><p>ThreeBodyTB has a set of pre-fit coefficients that are sufficient for running elemental or binary systems without doing your own fitting. If you still want to do the fitting yourself, read on...</p><p>Currently, ThreeBodyTB is set up to fit coefficients from <a href="https://www.quantum-espresso.org/">Quantum Espresso</a> (QE) DFT calculations from <code>pw.x</code> using the <code>projwfc.x</code> code to get atomic-wavefunction-projected band structures.</p><p>It may be easiest to consider the fitting example in the <code>examples/</code> folder while reading this.</p><p>A brief overview of the steps:</p><ol><li><p>Tell <code>ThreeBody.jl</code> where you QE code is, and optionally pseudopotentials, etc.</p></li><li><p>Run self-consistent-field (SCF) non-spin-polarized DFT total energy calculations.</p></li><li><p>Run <a href="../every/#ThreeBodyTB.AtomicProj.projwfc_workf-Tuple{dftout}"><code>ThreeBodyTB.AtomicProj.projwfc_workf</code></a> to get k-space tight-binding models for each SCF calculation. This runs a non-SCF DFT calculation with <code>pw.x</code> and atomic projections with <code>projwfc.x</code>, and then calculates the TB model.</p></li><li><p>Run the fitting code <a href="../every/#ThreeBodyTB.FitTB.do_fitting_recursive-Tuple{Any}"><code>ThreeBodyTB.FitTB.do_fitting_recursive</code></a></p></li></ol><h2 id=".-Preliminaries"><a class="docs-heading-anchor" href="#.-Preliminaries">0. Preliminaries</a><a id=".-Preliminaries-1"></a><a class="docs-heading-anchor-permalink" href="#.-Preliminaries" title="Permalink"></a></h2><p>You need to install Quantum Espresso (make pw; make pp) and let the code know where the bin/ directory is. For example, <a href="../every/#ThreeBodyTB.set_bin_dirs"><code>set_bin_dirs(qe=&quot;/home/kfg/codes/q-e-qe-6.5/bin/&quot;)</code></a>.  You also need to let it know about any mpi commands you may need to run in parallel unless you use mpirun. <code>set_bin_dirs(qe=&quot;/home/kfg/codes/q-e-qe-6.5/bin/&quot;, mpi=&quot;mpirun -np &quot;)</code>, where you must insert your appropriate command.</p><h3 id="Using-different-pseudopotential-or-convergence-settings."><a class="docs-heading-anchor" href="#Using-different-pseudopotential-or-convergence-settings.">Using different pseudopotential or convergence settings.</a><a id="Using-different-pseudopotential-or-convergence-settings.-1"></a><a class="docs-heading-anchor-permalink" href="#Using-different-pseudopotential-or-convergence-settings." title="Permalink"></a></h3><p>By default, the code is set up for the slightly modified <a href="https://www.physics.rutgers.edu/gbrv/">GBRV</a> pseudopotential set available in this distribution under <code>pseudo/gbrv_pbesol/</code>. The default template QE input files are in <code>template_inputs/</code>. You can change those directories as well with <code>set_bin_dirs(pseudodir=&quot;mypsp/&quot;, templatedir=&quot;mytemp/&quot;)</code></p><p>If you do change those, you will also have to edit <code>ThreeBodyTB.Atomdata:atoms</code>. In particular, you need to perform some non-spin-polarized isolated atom calculations to get atomic data. From those, you need the total energy, the number of semicore states, the types of valence orbitals, the energies of valence orbitals, and the U values. You can get U from calculations with variable numbers of electrons.</p><h2 id=".-Do-DFT-calculations."><a class="docs-heading-anchor" href="#.-Do-DFT-calculations.">1. Do DFT calculations.</a><a id=".-Do-DFT-calculations.-1"></a><a class="docs-heading-anchor-permalink" href="#.-Do-DFT-calculations." title="Permalink"></a></h2><p>You need SCF DFT data to fit to. Create crystal structures with <a href="../core/#ThreeBodyTB.CrystalMod.makecrys"><code>makecrys</code></a> and then run dft calculations. For example:</p><pre><code class="language-none">c = makecrys([10 0 0; 0 10 0; 0 0 10], [0 0 0], [&quot;H&quot;]);
dft = ThreeBodyTB.DFT.runSCF(c, directory=&quot;dirname&quot;, tmpdir=&quot;dirname&quot;,nprocs=8 )</code></pre><p>You can look in <code>code_for_dataset_gen/Prototypes.jl</code> and <code>reference_structures/</code> for examples of how to create a database of example structures.</p><p>You can load <code>dft</code> variables from the &quot;prefix.save/data-file-schema.xml&quot; output file as <code>dft = [</code>ThreeBodyTB.QE.loadXML<code>](@ref)(&quot;prefix.save&quot;)</code>. You will need the charge density in the next step to run the non-SCF calculation, but after that you don&#39;t need the wavefunctions or charge density from either the DFT or NSCF run.</p><h2 id=".-Create-the-tight-binding-Hamiltonian-for-each-DFT-calculation"><a class="docs-heading-anchor" href="#.-Create-the-tight-binding-Hamiltonian-for-each-DFT-calculation">2. Create the tight-binding Hamiltonian for each DFT calculation</a><a id=".-Create-the-tight-binding-Hamiltonian-for-each-DFT-calculation-1"></a><a class="docs-heading-anchor-permalink" href="#.-Create-the-tight-binding-Hamiltonian-for-each-DFT-calculation" title="Permalink"></a></h2><p>The function <a href="../every/#ThreeBodyTB.AtomicProj.projwfc_workf-Tuple{dftout}"><code>ThreeBodyTB.AtomicProj.projwfc_workf</code></a> will perform all of the calculations to create a projected tight-binding Hamiltonian from a DFT calculation (workf stands for workflow). The basic steps it will perform are:</p><ol><li><p>Run a non-SCF calculation with more bands, so that every atomic orbital can project onto bands.</p></li><li><p>Run projwfc.x to get the atomic wavefunction projected band structure (the file <code>prefix.save/atomic_proj.xml</code>).</p></li><li><p>Get the projected Hamiltonian in k-space.</p></li><li><p><em>(Optional)</em> Fourier transform to get the Hamiltonian in r-space</p></li></ol><p>The optional Fourier transform only works if the k-grid from the NSCF is a regular gamma centered MP grid without symmetry. However, this step isn&#39;t necessary for the main fitting procedure. You can use the Hamiltonian in k-space directly, saving computing time.</p><p>A typical call is</p><pre><code class="language-none">tbc, tbck, projection_warning = ThreeBodyTB.AtomicProj.projwfc_workf(
     dft,
     directory=&quot;dirname&quot;,
     nprocs=8,
     only_kspace=true)</code></pre><p><code>tbck</code> is the important return, which is the tight binding Hamiltonian in k-space <a href="../every/#ThreeBodyTB.TB.tb_crys_kspace"><code>tb_crys_kspace</code></a>. <code>projection_warning</code> will warn you if the quality of the projection is detected to be low. This can be caused by atoms that are too close together or not including enough empty bands to guarantee that all of the atomic wavefunctions can project onto some states.</p><p>In order to fit a SCF model, it is necessary to subtract the self-consistent part from the TB Hamiltonian with <a href="../every/#ThreeBodyTB.SCF.remove_scf_from_tbc-Tuple{Any, Any, Any}"><code>ThreeBodyTB.SCF.remove_scf_from_tbc</code></a>:</p><p><code>tbck_scf = ThreeBodyTB.SCF.remove_scf_from_tbc(tbck);</code></p><p>You can read/write either <code>tbck</code> or <code>tbck_scf</code> with <a href="../every/#ThreeBodyTB.TB.read_tb_crys_kspace"><code>ThreeBodyTB.TB.read_tb_crys_kspace</code></a> or <a href="../every/#ThreeBodyTB.TB.write_tb_crys_kspace"><code>ThreeBodyTB.TB.write_tb_crys_kspace</code></a></p><p>If <code>only_kspace=false</code> you will also get the real-space <code>tbc</code> output, which is similar to the &quot;prefix_hr.dat&quot; from Wannier90, and you can also use <code>remove_scf_from_tbc</code> on that struct and use it in the fitting. The read/write functions are <a href="../core/#ThreeBodyTB.TB.read_tb_crys"><code>ThreeBodyTB.read_tb_crys</code></a> and <a href="../core/#ThreeBodyTB.TB.write_tb_crys"><code>ThreeBodyTB.write_tb_crys</code></a>. These files can also be used to interpolate band structures or DOS to arbitrary k-points like a Wannier Hamiltonian, while the k-space versions are limited to fixed k-point grids.</p><h2 id=".-Do-actual-fitting"><a class="docs-heading-anchor" href="#.-Do-actual-fitting">3. Do actual fitting</a><a id=".-Do-actual-fitting-1"></a><a class="docs-heading-anchor-permalink" href="#.-Do-actual-fitting" title="Permalink"></a></h2><p>An example command to actually do the fitting is</p><pre><code class="language-none">database = ThreeBodyTB.FitTB.do_fitting_recursive(
	 tbck_scf_list,
	 dft_list = dft_list,
	 weights_list=weights_list,
	 starting_dict=starting_dict,
	 NLIM=50)</code></pre><p>Here, <code>tbck_scf_list</code> is an array of <code>tbck_scf</code> or <code>tbc_scf</code> variables (type <code>TB.tb_crys_kspace</code>), and <code>dft_list</code> is an array of <code>dft</code> variables (type <code>DFToutMod.dftout</code>). <code>weights_list</code> is an optional array of the real numbers with relative weights of the structures for the fitting. <code>NLIM</code> is the maximum number of k-points to use for each structure. Higher values will require more time to do the fitting.</p><p><code>starting_dict</code> is a dictionary of previously fit coefficients that are not included in the fitting and are kept frozen. For example, when fitting binaries, typically the elemental fitting coefficients are kept frozen to their elemental values.</p><p>There are many other options to this function. <code>ks_weight</code> and <code>rs_weight</code> are the k-space and real-space weights for fitting of the tight-binding matrix elements. Default is to set both to zero and only fit eigenvalues/energies. <code>energy_weight</code> is the weight of the total energy, relative to the eigenvalues. Default is <code>20.0</code>.  <code>niters</code> is the number of recursive iterations. <code>lambda</code> is a regularization parameter, default is <code>0.0</code> (no regularization). <code>RW_PARAM</code> is the weight of the fully empty eigenvalues relative to the filled ones. Default is <code>0.0</code> (no weight to high energy empty states, although there is some weight to states near the Fermi level).</p><h2 id=".-Run-calculations-with-new-database"><a class="docs-heading-anchor" href="#.-Run-calculations-with-new-database">4. Run calculations with new <code>database</code></a><a id=".-Run-calculations-with-new-database-1"></a><a class="docs-heading-anchor-permalink" href="#.-Run-calculations-with-new-database" title="Permalink"></a></h2><p>The dictionary returned by the fitting function has coefficient objects (type <a href="../every/#ThreeBodyTB.CalcTB.coefs"><code>ThreeBodyTB.CalcTB.coefs</code></a>) in it, as well as a variable on whether the coefficients require self-consistency or not. For example, if we fit Al coefficients, there will be keys with <code>(:Al, :Al)</code>, with the two-body interaction coefs, and <code>(:Al, :Al, :Al)</code> with the three body interactions, and a <code>bool</code> called <code>&quot;SCF&quot;</code>.</p><p>You can save the coefficients in xml files for use later with <code>ThreeBodyTB.CalcTB.write_coefs(&quot;Al_2bdy.xml&quot;, database[(:Al,Al)])</code> and read them with <code>ThreeBodyTB.CalcTB.read_coefs(&quot;Al_2bdy.xml&quot;)</code></p><p>You can use the coefficients to run a calculation by using <a href="../core/#ThreeBodyTB.scf_energy"><code>scf_energy(c; database = database)</code></a>, which will override the default database and use your database. The force/stress and relaxations similarly take <code>database</code> variables.</p><p>There is also a way to manage a directory with coefficients in it. You have to setup your directory structure the same way as <code>dats/pbesol/v1.2/</code>. Then, you can also load coefficients as needed for crystal <code>c</code> stored in a directory using <a href="../every/#ThreeBodyTB.ManageDatabase.prepare_database-Tuple{Any}"><code>ThreeBodyTB.ManageDatabase.prepare_database(c; directory=&quot;dirname&quot;)</code></a> into the internal database cache, instead of loading from the default directory with pre-fit coefficients. Note, this will only work if the coefficients follow my naming conventions.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ug_run/">« Running Calculations</a><a class="docs-footer-nextpage" href="../structs/">Structs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 21 July 2021 16:35">Wednesday 21 July 2021</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
